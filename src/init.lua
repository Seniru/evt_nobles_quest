local IS_TEST = true

tfm.exec.disableAfkDeath()
tfm.exec.disableAutoShaman()

math.randomseed(os.time())
-- NOTE: Sometimes the script is loaded twice in the same round (detect it when eventNewGame is called twice). You must use system.exit() is this case, because it doesn't load the player data correctly, and the textareas (are duplicated) doesn't trigger eventTextAreaCallback.
local eventLoaded, mapLoaded, eventEnding = false, false, false
local mapPlaying = ""

-- final boss battle
local bossBattleTriggered, divineChargeTimeOver, divinePowerCasted = false, false, false
local divinePowerCharge = 0
local FINAL_BOSS_ATK_MAX_CHARGE = 2000

local maps = {
	mine = [[<C><P L="1622" H="1720" APS="17f322853ac.png,,820,1329,800,317,0,800" Ca="" MEDATA=";;;;0,1-0;0:::1-"/><Z><S><S T="1" X="1628" Y="1208" L="10" H="2016" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="1" X="-7" Y="1296" L="10" H="2016" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="0" X="5" Y="805" L="11" H="10" P="0,0,0.3,0.2,2880,0,0,0" c="4" nosync="" i="0,0,17f32282dfc.png"/><S T="0" X="30" Y="1002" L="61" H="10" P="0,0,0.3,0.2,2890,0,0,0" m=""/><S T="0" X="85" Y="1021" L="59" H="10" P="0,0,0.3,0.2,2910,0,0,0" m=""/><S T="0" X="149" Y="1119" L="139" H="10" P="0,0,0.3,0.2,2950,0,0,0" m=""/><S T="0" X="119" Y="1046" L="26" H="10" P="0,0,0.3,0.2,2930,0,0,0" m=""/><S T="0" X="209" Y="1199" L="102" H="10" P="0,0,0.3,0.2,2918,0,0,0" m=""/><S T="0" X="264" Y="1253" L="57" H="10" P="0,0,0.3,0.2,2950,0,0,0" m=""/><S T="0" X="298" Y="1309" L="79" H="10" P="0,0,0.3,0.2,2930,0,0,0" m=""/><S T="0" X="321" Y="1362" L="49" H="10" P="0,0,0.3,0.2,2970,0,0,0" m=""/><S T="0" X="524" Y="1335" L="230" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="235" Y="1458" L="230" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="667" Y="1274" L="88" H="10" P="0,0,0.3,0.2,2850,0,0,0" m=""/><S T="0" X="778" Y="1225" L="163" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="957" Y="1198" L="212" H="10" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="1082" Y="1190" L="54" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="1130" Y="1180" L="69" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="1193" Y="1146" L="85" H="12" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="1237" Y="1133" L="67" H="10" P="0,0,0.3,0.2,2800,0,0,0" m=""/><S T="0" X="1314" Y="1063" L="161" H="10" P="0,0,0.3,0.2,2850,0,0,0" m=""/><S T="0" X="1430" Y="1014" L="94" H="10" P="0,0,0.3,0.2,2870,0,0,0" m=""/><S T="0" X="1532" Y="1007" L="113" H="10" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="1602" Y="1010" L="34" H="10" P="0,0,0.3,0.2,2890,0,0,0" m=""/><S T="4" X="357" Y="1473" L="10" H="235" P="0,0,20,0.2,2910,0,0,0" m=""/><S T="0" X="900" Y="1644" L="1800" H="22" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="894" Y="1662" L="136" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="1003" Y="1611" L="121" H="10" P="0,0,0.3,0.2,2870,0,0,0" m=""/><S T="0" X="1121" Y="1595" L="118" H="10" P="0,0,0.3,0.2,2875,0,0,0" m=""/><S T="0" X="1528" Y="1650" L="118" H="10" P="0,0,0.3,0.2,2915,0,0,0" m=""/><S T="0" X="1332" Y="1604" L="314" H="10" P="0,0,0.3,0.2,2885,0,0,0" m=""/><S T="0" X="245" Y="1610" L="200" H="10" P="0,0,0.3,0.2,2900,0,0,0" m=""/><S T="1" X="150" Y="1659" L="10" H="268" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="8" X="1261" Y="1470" L="718" H="375" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="2"/><S T="8" X="154" Y="1049" L="302" H="499" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="3"/><S T="8" X="730" Y="1195" L="264" H="151" P="0,0,0.3,0.2,0,0,0,0" c="2" lua="4"/><S T="8" X="799" Y="313" L="670" H="520" P="0,0,0.3,0.2,5400,0,0,0" c="2" lua="7"/><S T="5" X="470" Y="123" L="154" H="42" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="1140" Y="123" L="154" H="42" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="491" Y="90" L="91" H="31" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="471" Y="337" L="91" H="31" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="490" Y="333" L="91" H="31" P="0,0,0.3,0.2,130,0,0,0"/><S T="5" X="1124" Y="346" L="91" H="31" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="1119" Y="90" L="91" H="31" P="0,0,0.3,0.2,-110,0,0,0"/><S T="5" X="512" Y="82" L="78" H="42" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="1098" Y="82" L="78" H="42" P="0,0,0.3,0.2,-150,0,0,0"/><S T="8" X="1308" Y="1075" L="630" H="257" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="5"/><S T="8" X="75" Y="1599" L="157" H="107" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="6"/><S T="8" X="563" Y="1594" L="157" H="107" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="8"/><S T="5" X="922" Y="214" L="110" H="23" P="0,0,0.3,0.2,140,0,0,0"/><S T="5" X="569" Y="257" L="58" H="23" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="858" Y="256" L="58" H="23" P="0,0,0.3,0.2,160,0,0,0"/><S T="5" X="1045" Y="227" L="49" H="23" P="0,0,0.3,0.2,180,0,0,0"/><S T="5" X="999" Y="206" L="74" H="23" P="0,0,0.3,0.2,220,0,0,0"/><S T="5" X="902" Y="408" L="58" H="23" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="563" Y="294" L="196" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="728" Y="338" L="101" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="653" Y="372" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="884" Y="370" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="1098" Y="336" L="101" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="1110" Y="348" L="47" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="1101" Y="450" L="156" H="23" P="0,0,0.3,0.2,280,0,0,0"/><S T="5" X="823" Y="196" L="101" H="23" P="0,0,0.3,0.2,-20,0,0,0"/><S T="5" X="644" Y="194" L="45" H="23" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="733" Y="143" L="33" H="23" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="835" Y="103" L="195" H="23" P="0,0,0.3,0.2,160,0,0,0"/><S T="5" X="637" Y="120" L="157" H="23" P="0,0,0.3,0.2,240,0,0,0"/><S T="5" X="918" Y="179" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="1064" Y="370" L="161" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="978" Y="127" L="129" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="938" Y="511" L="129" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="799" Y="339" L="111" H="23" P="0,0,0.3,0.2,-140,0,0,0"/><S T="5" X="743" Y="261" L="101" H="23" P="0,0,0.3,0.2,70,0,0,0"/><S T="5" X="611" Y="463" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="763" Y="499" L="101" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="941" Y="448" L="101" H="23" P="0,0,0.3,0.2,-180,0,0,0"/><S T="5" X="816" Y="526" L="101" H="23" P="0,0,0.3,0.2,20,0,0,0"/><S T="5" X="497" Y="351" L="138" H="23" P="0,0,0.3,0.2,130,0,0,0"/><S T="5" X="508" Y="431" L="138" H="23" P="0,0,0.3,0.2,210,0,0,0"/><S T="5" X="469" Y="494" L="156" H="23" P="0,0,0.3,0.2,270,0,0,0"/><S T="5" X="544" Y="548" L="156" H="23" P="0,0,0.3,0.2,350,0,0,0"/><S T="5" X="592" Y="557" L="156" H="23" P="0,0,0.3,0.2,360,0,0,0"/><S T="5" X="883" Y="546" L="528" H="44" P="0,0,0.3,0.2,360,0,0,0"/><S T="5" X="1047" Y="294" L="196" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="451" Y="313" L="30" H="550" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="478" Y="240" L="94" H="26" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="1123" Y="457" L="163" H="26" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="1112" Y="492" L="163" H="26" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="1132" Y="240" L="94" H="26" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="1124" Y="175" L="130" H="23" P="0,0,0.3,0.2,-110,0,0,0"/><S T="5" X="808" Y="575" L="700" H="26" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="804" Y="76" L="526" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="492" Y="158" L="94" H="23" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="540" Y="88" L="94" H="23" P="0,0,0.3,0.2,140,0,0,0"/><S T="5" X="1150" Y="313" L="32" H="550" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="1070" Y="88" L="94" H="23" P="0,0,0.3,0.2,-140,0,0,0"/><S T="5" X="815" Y="52" L="700" H="28" P="0,0,0.3,0.2,0,0,0,0"/><S T="12" X="812" Y="1751" L="1640" H="207" P="0,0,0.3,0.2,0,0,0,0" o="533d2e"/></S><D><DS X="947" Y="1180"/></D><O><O X="31" Y="952" C="22" nosync="" P="0" type="tree"/><O X="212" Y="1145" C="22" nosync="" P="0" type="tree"/><O X="259" Y="1198" C="22" nosync="" P="0" type="tree"/><O X="1272" Y="1502" C="22" nosync="" P="0" type="npc" name="nosferatu"/><O X="732" Y="1192" C="22" nosync="" P="0" type="craft_table"/><O X="580" Y="1576" C="22" nosync="" P="0" type="recipe" name="basic_axe"/><O X="1036" Y="334" C="22" nosync="" P="0" type="recipe" name="basic_shovel"/><O X="1449" Y="987" C="22" nosync="" P="0" type="rock"/><O X="1554" Y="981" C="22" nosync="" P="0" type="rock"/><O X="1186" Y="1132" C="22" nosync="" P="0" type="rock"/><O X="1535" Y="1599" C="11" nosync="" P="0" type="teleport" route="mine" id="1"/><O X="504" Y="528" C="11" nosync="" P="0" type="teleport" route="mine" id="2"/><O X="1029" Y="1175" C="22" nosync="" P="0" type="tree"/><O X="56" Y="1605" C="22" nosync="" P="0" type="tree"/><O X="584" Y="431" C="22" nosync="" P="0" type="rock"/><O X="521" Y="264" C="22" nosync="" P="0" type="rock"/><O X="629" Y="169" C="22" nosync="" P="0" type="copper_ore"/><O X="779" Y="89" C="22" nosync="" P="0" type="gold_ore"/><O X="888" Y="208" C="22" nosync="" P="0" type="copper_ore"/><O X="1031" Y="189" C="22" nosync="" P="0" type="iron_ore"/><O X="856" Y="342" C="22" nosync="" P="0" type="rock"/><O X="1053" Y="507" C="22" nosync="" P="0" type="rock"/><O X="1004" Y="504" C="22" nosync="" P="0" type="rock"/><O X="933" Y="417" C="22" nosync="" P="0" type="iron_ore"/></O><L/></Z></C>]],
	castle = [[<C><P L="2000" H="6000" MEDATA="81,1;;;;-0;0::0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21:1-"/><Z><S><S T="0" X="7" Y="2745" L="10" H="10" P="0,0,0.3,0.2,0,0,0,0" i="0,0,17f9dab706f.jpg"/><S T="0" X="89" Y="3226" L="197" H="10" P="0,0,0.3,0.2,30,0,0,0" m=""/><S T="0" X="54" Y="3174" L="197" H="10" P="0,0,0.3,0.2,50,0,0,0" m=""/><S T="0" X="269" Y="3258" L="197" H="10" P="0,0,0.3,0.2,-10,0,0,0" m=""/><S T="0" X="530" Y="3241" L="330" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="654" Y="3241" L="197" H="10" P="0,0,0.3,0.2,-10,0,0,0" m=""/><S T="0" X="849" Y="3224" L="197" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1027" Y="3224" L="158" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1194" Y="3240" L="197" H="10" P="0,0,0.3,0.2,10,0,0,0" m=""/><S T="0" X="1700" Y="3217" L="197" H="10" P="0,0,0.3,0.2,20,0,0,0" m=""/><S T="0" X="1514" Y="3184" L="197" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1713" Y="3237" L="197" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1687" Y="3021" L="51" H="10" P="0,0,0.3,0.2,230,0,0,0" m=""/><S T="0" X="1641" Y="2987" L="51" H="10" P="0,0,0.3,0.2,200,0,0,0" m=""/><S T="0" X="1600" Y="2983" L="51" H="10" P="0,0,0.3,0.2,170,0,0,0" m=""/><S T="0" X="1566" Y="2996" L="51" H="10" P="0,0,0.3,0.2,160,0,0,0" m=""/><S T="0" X="1854" Y="3263" L="103" H="10" P="0,0,0.3,0.2,30,0,0,0" m=""/><S T="0" X="1994" Y="3512" L="103" H="10" P="0,0,0.3,0.2,-80,0,0,0" m=""/><S T="0" X="1959" Y="3606" L="103" H="10" P="0,0,0.3,0.2,-60,0,0,0" m=""/><S T="0" X="1903" Y="3687" L="103" H="10" P="0,0,0.3,0.2,-50,0,0,0" m=""/><S T="0" X="1820" Y="3743" L="103" H="10" P="0,0,0.3,0.2,-20,0,0,0" m=""/><S T="0" X="1726" Y="3767" L="103" H="10" P="0,0,0.3,0.2,-10,0,0,0" m=""/><S T="0" X="1540" Y="3781" L="103" H="10" P="0,0,0.3,0.2,-30,0,0,0" m=""/><S T="0" X="1444" Y="3814" L="103" H="10" P="0,0,0.3,0.2,-10,0,0,0" m=""/><S T="0" X="1356" Y="3817" L="103" H="10" P="0,0,0.3,0.2,10,0,0,0" m=""/><S T="0" X="1154" Y="3809" L="305" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="956" Y="3826" L="103" H="10" P="0,0,0.3,0.2,-20,0,0,0" m=""/><S T="1" X="-3" Y="3091" L="10" H="2000" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="2009" Y="3091" L="10" H="2000" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="1168" Y="3019" L="10" H="482" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="1092" Y="3184" L="10" H="76" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="1121" Y="3135" L="10" H="76" P="0,0,0,0.2,50,0,0,0" m=""/><S T="0" X="1910" Y="3309" L="53" H="10" P="0,0,0.3,0.2,60,0,0,0" m=""/><S T="4" X="2003" Y="3381" L="10" H="190" P="0,0,20,0.2,0,0,0,0" m=""/><S T="1" X="1535" Y="2948" L="10" H="453" P="0,0,0,0.2,0,0,0,0" m=""/><S T="0" X="151" Y="4046" L="442" H="10" P="0,0,0.3,0.2,-10,0,0,0" m=""/><S T="0" X="586" Y="3977" L="442" H="10" P="0,0,0.3,0.2,-8,0,0,0" m=""/><S T="0" X="1024" Y="3955" L="442" H="10" P="0,0,0.3,0.2,2,0,0,0" m=""/><S T="0" X="1064" Y="3955" L="442" H="10" P="0,0,0.3,0.2,2,0,0,0" m=""/><S T="0" X="1449" Y="3952" L="329" H="10" P="0,0,0.3,0.2,-4,0,0,0" m=""/><S T="0" X="1805" Y="3942" L="387" H="10" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1622" Y="3830" L="163" H="10" P="0,0,0.3,0.2,-44,0,0,0" m=""/><S T="4" X="1706" Y="3095" L="10" H="109" P="0,0,20,0.2,0,0,0,0" m=""/><S T="1" X="1700" Y="3083" L="10" H="109" P="0,0,0,0.2,0,0,0,0" m=""/><S T="8" X="588" Y="3011" L="1173" H="535" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="1"/><S T="8" X="1402" Y="2342" L="900" H="405" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="2" i="0,0,180938afb04.png"/><S T="8" X="594" Y="4646" L="798" H="410" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="5" i="-117,0,180938afb04.png"/><S T="12" X="1355" Y="5215" L="58" H="273" P="0,0,0.3,0.2,0,0,0,0" o="324650" m="" lua="4"/><S T="1" X="852" Y="4643" L="83" H="450" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="4" Y="4429" L="1990" H="57" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="995" Y="5051" L="1990" H="57" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="47" Y="4693" L="63" H="340" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="-33" Y="5262" L="63" H="440" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="1895" Y="2323" L="80" H="500" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="914" Y="2323" L="80" H="500" P="0,0,0,0.2,0,0,0,0" m=""/><S T="1" X="1405" Y="2107" L="80" H="1025" P="0,0,0,0.2,90,0,0,0" m=""/><S T="1" X="2031" Y="5286" L="80" H="500" P="0,0,0,0.2,0,0,0,0" m=""/><S T="0" X="453" Y="4828" L="890" H="67" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="0" X="1414" Y="2518" L="915" H="67" P="0,0,0.3,0.2,0,0,0,0" m=""/><S T="1" X="546" Y="4526" L="954" H="10" P="0,0,0,0.2,0,0,0,0" m=""/><S T="8" X="999" Y="5280" L="1987" H="391" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="3"/><S T="8" X="996" Y="3869" L="2009" H="391" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="6"/><S T="12" X="1682" Y="5408" L="727" H="147" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="357" Y="5398" L="814" H="147" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="8" X="998" Y="945" L="1995" H="1900" P="0,0,0.3,0.2,0,0,0,0" c="4"/><S T="10" X="400" Y="1860" L="800" H="80" P="0,0,0.3,0,0,0,0,0" c="3"/><S T="10" X="600" Y="1780" L="80" H="80" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="400" Y="1490" L="80" H="10" P="1,-1,0.3,0,0,1,0,0" m=""/><S T="10" X="760" Y="1700" L="80" H="80" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="440" Y="1700" L="80" H="80" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="320" Y="1600" L="80" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="600" Y="1640" L="80" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="360" Y="1720" L="80" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="600" Y="1520" L="400" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="420" Y="1440" L="120" H="120" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="200" Y="1520" L="80" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="300" Y="1440" L="120" H="40" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="80" Y="1440" L="80" H="40" P="0,-1,0.3,0,0,0,0,0"/><S T="10" X="20" Y="1420" L="40" H="80" P="0,-1,0.3,0,0,0,0,0" c="3"/><S T="10" X="400" Y="1200" L="80" H="120" P="0,-1,0.3,0,0,0,0,0" c="3"/><S T="10" X="120" Y="1700" L="240" H="240" P="0,0,0.3,0,360,0,0,0"/><S T="10" X="1220" Y="770" L="40" H="1300" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="920" Y="1460" L="640" H="80" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="600" Y="1120" L="1200" H="40" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="700" Y="820" L="1000" H="40" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="520" Y="480" L="1040" H="40" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="600" Y="140" L="1200" H="40" P="0,0,0.3,0,-360,0,0,0"/><S T="10" X="240" Y="1280" L="400" H="40" P="0,0,0.3,0,-360,0,0,0"/><S T="12" X="760" Y="1820" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="6D4E94" c="3"/><S T="12" X="30" Y="1580" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="000000" c="2" m=""/><S T="12" X="810" Y="1660" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="000000" c="2" m=""/><S T="12" X="360" Y="1390" L="38" H="20" P="1,20,0.3,0.2,0,1,2000,0" o="000000" c="2" m=""/><S T="12" X="30" Y="1420" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="000000" c="2" m=""/><S T="12" X="80" Y="1520" L="80" H="120" P="1,20,0,0,0,1,0,0" o="6D4E94"/><S T="12" X="760" Y="1600" L="80" H="120" P="1,20,0,0,0,1,0,0" o="68A2C4"/><S T="12" X="80" Y="1360" L="80" H="120" P="1,20,0,0,0,1,0,0" o="007D42"/><S T="12" X="400" Y="1340" L="80" H="80" P="1,20,0,0,0,1,0,0" o="C6C96D"/><S T="12" X="80" Y="1580" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="68A2C4" c="3"/><S T="12" X="760" Y="1660" L="20" H="40" P="1,20,0.3,0.2,0,1,2000,0" o="007D42" c="3"/><S T="12" X="40" Y="1410" L="40" H="20" P="1,20,0.3,0.2,0,1,2000,0" o="C6C96D" c="3"/><S T="1" X="960" Y="1020" L="40" H="160" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="780" Y="380" L="40" H="160" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="460" Y="380" L="40" H="160" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="460" Y="200" L="40" H="80" P="0,0,0,0.2,180,0,0,0"/><S T="1" X="780" Y="200" L="40" H="80" P="0,0,0,0.2,180,0,0,0"/><S T="1" X="580" Y="1040" L="40" H="120" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="500" Y="740" L="40" H="120" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="100" Y="1000" L="40" H="200" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="220" Y="700" L="40" H="200" P="0,0,0,0.2,0,0,0,0"/><S T="1" X="360" Y="600" L="40" H="200" P="0,0,0,0.2,180,0,0,0"/><S T="10" X="1000" Y="310" L="280" H="20" P="0,0,0.3,0,90,0,0,0"/><S T="10" X="620" Y="330" L="240" H="20" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="720" Y="650" L="160" H="300" P="0,0,0.3,0,0,0,0,0"/><S T="10" X="1120" Y="740" L="160" H="120" P="0,0,0.3,0,0,0,0,0"/></S><D><P X="1160" Y="1400" T="11" P="0,0"/><P X="540" Y="780" T="11" P="0,0"/><P X="40" Y="450" T="11" P="0,0"/><DS X="600" Y="1730"/></D><O><O X="322" Y="3221" C="22" nosync="" P="0" type="npc" name="edric"/><O X="1219" Y="2471" C="11" nosync="" P="0" type="teleport" route="arena" id="2"/><O X="371" Y="3173" C="11" nosync="" P="0" type="teleport" route="arena" id="1"/><O X="1013" Y="2466" C="14" nosync="" P="0" type="monster_spawn"/><O X="1789" Y="2455" C="14" nosync="" P="0" type="monster_spawn"/><O X="919" Y="4757" C="14" nosync="" P="0" type="final_boss"/><O X="1952" Y="3906" C="11" nosync="" P="0" type="teleport" route="bridge" id="1"/><O X="387" Y="5275" C="11" nosync="" P="0" type="teleport" route="bridge" id="2"/><O X="672" Y="3936" C="22" nosync="" P="0" type="recipe" name="bridge"/><O X="721" Y="5307" C="22" nosync="" P="0" type="bridge"/><O X="1908" Y="5263" C="14" nosync="" P="0" type="fiery_dragon"/><O X="540" Y="740" C="11" P="0"/><O X="1160" Y="1360" C="11" P="0"/><O X="40" Y="410" C="11" P="0"/><O X="1040" Y="1090" C="7" P="0"/><O X="660" Y="1090" C="7" P="0"/><O X="180" Y="1090" C="7" P="0"/><O X="420" Y="790" C="7" P="0"/><O X="1040" Y="1090" C="11" P="0"/><O X="660" Y="1090" C="11" P="0"/><O X="180" Y="1090" C="11" P="0"/><O X="420" Y="790" C="11" P="0"/><O X="240" Y="380" C="423" P="-60,0"/><O X="890" Y="710" C="423" P="60,0"/><O X="1040" Y="590" C="423" P="60,0"/><O X="288" Y="298" C="11" P="0"/><O X="842" Y="628" C="11" P="0"/><O X="992" Y="508" C="11" P="0"/></O><L><JP M1="88" M2="65" AXIS="0,1"/><JP M1="93" M2="65" AXIS="1,0" LIM1="0" LIM2="Infinity" MV="1,6.666666666666667"/><JP M1="89" M2="65" AXIS="0,1"/><JD M1="89" M2="88"/><JP M1="97" M2="65" AXIS="0,1"/><JP M1="90" M2="65" AXIS="0,1"/><JP M1="94" M2="65" AXIS="1,0" LIM1="-Infinity" LIM2="0" MV="1,-6.666666666666667"/><JD M1="97" M2="90"/><JP M1="98" M2="65" AXIS="0,1"/><JP M1="92" M2="65" AXIS="0,1"/><JD M1="92" M2="98"/><JP M1="95" M2="65" AXIS="1,0" LIM1="0" LIM2="Infinity" MV="1,6.666666666666667"/><JP M1="99" M2="65" AXIS="1,0"/><JP M1="96" M2="65" AXIS="0,1" LIM1="-Infinity" LIM2="0" MV="1,6.666666666666667"/><JD M1="99" M2="91"/><JP M1="91" M2="65" AXIS="1,0"/><JD c="C55924,4,1,0" P1="640,1720" P2="650,1725"/><JD c="C55924,4,1,0" P1="500,1370" P2="510,1375"/><JD c="C55924,4,1,0" P1="640,1730" P2="650,1725"/><JD c="C55924,4,1,0" P1="500,1380" P2="510,1375"/><JR M1="111" M2="84" P1="620,330" MV="Infinity,1.4"/><JR M1="110" M2="84" P1="1000,310" MV="Infinity,1.4"/></L></Z></C>
]]

}

local keys = {
	LEFT 	= 0,
	JUMP 	= 1,
	RIGHT 	= 2,
	DUCK 	= 3,
	SPACE 	= 32,
	KEY_0 	= 48,
	KEY_1	= 49,
	KEY_2	= 50,
	KEY_3	= 51,
	KEY_4	= 52,
	KEY_5	= 53,
	KEY_6	= 54,
	KEY_7	= 55,
	KEY_8	= 56,
	KEY_9	= 57,
	KEY_R 	= 82,
	KEY_X	= 88
}

local assets = {
	ui = {
		reply = "171d2f983ba.png",
		btnNext = "17eaa38a3f8.png",
		inventory = "17ff9b6b11f.png",
		dialogue_proceed = "180c6623296.png",
		dialogue_replies = "180c6a27f57.png"
	},
	damageFg = "17f2a88995c.png",
	damageBg = "17f2a890350.png",
	stone = "18093cce38d.png",
	spit = "180a896aac3.png"
}

local dHandler = DataHandler.new("evt_nq", {
	recipes = {
		index = 1,
		type = "number",
		default = 0
	},
	questProgress = {
		index = 2,
		type = "string",
		default = ""
	},
	inventory = {
		index = 3,
		type = "string",
		default = ""
	}
})

local teleports = {
	mine = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.nosferatu
			return quest and (quest.completed or quest.stage >= 3)
		end,
		onEnter = function(player, terminalId)
			tfm.exec.setPlayerNightMode(terminalId == 2, player.name)
		end
	},
	arena = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.strength_test
			return quest and (quest.completed or quest.stage >= 2)
		end
	},
	bridge = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.strength_test
			return quest and quest.completed
		end
	}
}

local directionSequence = {}
local projectiles = {}

local mineQuestCompletedPlayers, mineQuestIncompletedPlayers, totalPlayers, totalProcessedPlayers = 0, 0, 0, 0



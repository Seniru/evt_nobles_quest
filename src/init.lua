local IS_TEST = true

tfm.exec.disableAfkDeath()

math.randomseed(os.time())
-- NOTE: Sometimes the script is loaded twice in the same round (detect it when eventNewGame is called twice). You must use system.exit() is this case, because it doesn't load the player data correctly, and the textareas (are duplicated) doesn't trigger eventTextAreaCallback.
local eventLoaded, mapLoaded, eventEnding = false, false, false
local mapPlaying = ""

-- final boss battle
local bossBattleTriggered, divineChargeTimeOver, divinePowerCasted = false, false, false
local divinePowerCharge = 0
local FINAL_BOSS_ATK_MAX_CHARGE = 2000

local maps = {
	mine = [[<C><P L="9000" H="1600" D="17f32282dfc.png,2,5" APS="17f322853ac.png,,820,535,800,317,-1,0" Ca="" MEDATA=";;;;-0;0:::1-"/><Z><S><S T="1" X="1628" Y="108" L="10" H="2016" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="1" X="-7" Y="196" L="10" H="2016" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="0" X="5" Y="5" L="11" H="10" P="0,0,0.3,0.2,2880,0,0,0" c="4" nosync="" i="0,0,17f32282dfc.png"/><S T="0" X="30" Y="202" L="61" H="10" P="0,0,0.3,0.2,2890,0,0,0" m=""/><S T="0" X="85" Y="221" L="59" H="10" P="0,0,0.3,0.2,2910,0,0,0" m=""/><S T="0" X="149" Y="319" L="139" H="10" P="0,0,0.3,0.2,2950,0,0,0" m=""/><S T="0" X="119" Y="246" L="26" H="10" P="0,0,0.3,0.2,2930,0,0,0" m=""/><S T="0" X="209" Y="399" L="102" H="10" P="0,0,0.3,0.2,2918,0,0,0" m=""/><S T="0" X="264" Y="453" L="57" H="10" P="0,0,0.3,0.2,2950,0,0,0" m=""/><S T="0" X="298" Y="509" L="79" H="10" P="0,0,0.3,0.2,2930,0,0,0" m=""/><S T="0" X="321" Y="562" L="49" H="10" P="0,0,0.3,0.2,2970,0,0,0" m=""/><S T="0" X="524" Y="535" L="230" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="235" Y="658" L="230" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="667" Y="474" L="88" H="10" P="0,0,0.3,0.2,2850,0,0,0" m=""/><S T="0" X="778" Y="425" L="163" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="957" Y="398" L="212" H="10" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="1082" Y="390" L="54" H="10" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="1130" Y="380" L="69" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="1193" Y="346" L="85" H="12" P="0,0,0.3,0.2,2860,0,0,0" m=""/><S T="0" X="1237" Y="333" L="67" H="10" P="0,0,0.3,0.2,2800,0,0,0" m=""/><S T="0" X="1314" Y="263" L="161" H="10" P="0,0,0.3,0.2,2850,0,0,0" m=""/><S T="0" X="1430" Y="214" L="94" H="10" P="0,0,0.3,0.2,2870,0,0,0" m=""/><S T="0" X="1532" Y="207" L="113" H="10" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="1602" Y="210" L="34" H="10" P="0,0,0.3,0.2,2890,0,0,0" m=""/><S T="4" X="357" Y="673" L="10" H="235" P="0,0,20,0.2,2910,0,0,0" m=""/><S T="0" X="900" Y="844" L="1800" H="22" P="0,0,0.3,0.2,2880,0,0,0" m=""/><S T="0" X="894" Y="862" L="136" H="10" P="0,0,0.3,0.2,2840,0,0,0" m=""/><S T="0" X="1003" Y="811" L="121" H="10" P="0,0,0.3,0.2,2870,0,0,0" m=""/><S T="0" X="1121" Y="795" L="118" H="10" P="0,0,0.3,0.2,2875,0,0,0" m=""/><S T="0" X="1528" Y="850" L="118" H="10" P="0,0,0.3,0.2,2915,0,0,0" m=""/><S T="0" X="1332" Y="804" L="314" H="10" P="0,0,0.3,0.2,2885,0,0,0" m=""/><S T="0" X="245" Y="810" L="200" H="10" P="0,0,0.3,0.2,2900,0,0,0" m=""/><S T="1" X="150" Y="859" L="10" H="268" P="0,0,0,0.2,2880,0,0,0" m=""/><S T="8" X="1261" Y="670" L="718" H="375" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="2"/><S T="8" X="148" Y="253" L="302" H="499" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="3"/><S T="8" X="730" Y="395" L="264" H="151" P="0,0,0.3,0.2,0,0,0,0" c="2" lua="4"/><S T="8" X="3893" Y="591" L="670" H="520" P="0,0,0.3,0.2,0,0,0,0" c="2" lua="7"/><S T="5" X="3564" Y="401" L="154" H="42" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="4234" Y="401" L="154" H="42" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="3585" Y="368" L="91" H="31" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="3565" Y="615" L="91" H="31" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="3584" Y="611" L="91" H="31" P="0,0,0.3,0.2,130,0,0,0"/><S T="5" X="4218" Y="624" L="91" H="31" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="4213" Y="368" L="91" H="31" P="0,0,0.3,0.2,-110,0,0,0"/><S T="5" X="3606" Y="360" L="78" H="42" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="4192" Y="360" L="78" H="42" P="0,0,0.3,0.2,-150,0,0,0"/><S T="8" X="1308" Y="275" L="630" H="257" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="5"/><S T="8" X="75" Y="799" L="157" H="107" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="6"/><S T="8" X="563" Y="794" L="157" H="107" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="8"/><S T="5" X="4016" Y="492" L="110" H="23" P="0,0,0.3,0.2,140,0,0,0"/><S T="5" X="3663" Y="535" L="58" H="23" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="3952" Y="534" L="58" H="23" P="0,0,0.3,0.2,160,0,0,0"/><S T="5" X="4139" Y="505" L="49" H="23" P="0,0,0.3,0.2,180,0,0,0"/><S T="5" X="4093" Y="484" L="74" H="23" P="0,0,0.3,0.2,220,0,0,0"/><S T="5" X="3996" Y="686" L="58" H="23" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="3657" Y="572" L="196" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3822" Y="616" L="101" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="3747" Y="650" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3978" Y="648" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="4192" Y="614" L="101" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="4204" Y="626" L="47" H="23" P="0,0,0.3,0.2,-50,0,0,0"/><S T="5" X="4195" Y="728" L="156" H="23" P="0,0,0.3,0.2,280,0,0,0"/><S T="5" X="3917" Y="474" L="101" H="23" P="0,0,0.3,0.2,-20,0,0,0"/><S T="5" X="3738" Y="472" L="45" H="23" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="3827" Y="421" L="33" H="23" P="0,0,0.3,0.2,150,0,0,0"/><S T="5" X="3929" Y="381" L="195" H="23" P="0,0,0.3,0.2,160,0,0,0"/><S T="5" X="3731" Y="398" L="157" H="23" P="0,0,0.3,0.2,240,0,0,0"/><S T="5" X="4012" Y="457" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="4158" Y="648" L="161" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="4072" Y="405" L="129" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="4032" Y="789" L="129" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="3893" Y="617" L="111" H="23" P="0,0,0.3,0.2,-140,0,0,0"/><S T="5" X="3837" Y="539" L="101" H="23" P="0,0,0.3,0.2,70,0,0,0"/><S T="5" X="3705" Y="741" L="101" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3857" Y="777" L="101" H="23" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="4035" Y="726" L="101" H="23" P="0,0,0.3,0.2,-180,0,0,0"/><S T="5" X="3910" Y="804" L="101" H="23" P="0,0,0.3,0.2,20,0,0,0"/><S T="5" X="3591" Y="629" L="138" H="23" P="0,0,0.3,0.2,130,0,0,0"/><S T="5" X="3602" Y="709" L="138" H="23" P="0,0,0.3,0.2,210,0,0,0"/><S T="5" X="3563" Y="772" L="156" H="23" P="0,0,0.3,0.2,270,0,0,0"/><S T="5" X="3638" Y="826" L="156" H="23" P="0,0,0.3,0.2,350,0,0,0"/><S T="5" X="3686" Y="835" L="156" H="23" P="0,0,0.3,0.2,360,0,0,0"/><S T="5" X="3977" Y="824" L="528" H="44" P="0,0,0.3,0.2,360,0,0,0"/><S T="5" X="4141" Y="572" L="196" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3545" Y="591" L="30" H="550" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3572" Y="518" L="94" H="26" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="4217" Y="735" L="163" H="26" P="0,0,0.3,0.2,90,0,0,0"/><S T="5" X="4206" Y="770" L="163" H="26" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="4226" Y="518" L="94" H="26" P="0,0,0.3,0.2,-90,0,0,0"/><S T="5" X="4218" Y="453" L="130" H="23" P="0,0,0.3,0.2,-110,0,0,0"/><S T="5" X="3902" Y="853" L="700" H="26" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3898" Y="354" L="526" H="23" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="3586" Y="436" L="94" H="23" P="0,0,0.3,0.2,110,0,0,0"/><S T="5" X="3634" Y="366" L="94" H="23" P="0,0,0.3,0.2,140,0,0,0"/><S T="5" X="4244" Y="591" L="32" H="550" P="0,0,0.3,0.2,0,0,0,0"/><S T="5" X="4164" Y="366" L="94" H="23" P="0,0,0.3,0.2,-140,0,0,0"/><S T="5" X="3909" Y="330" L="700" H="28" P="0,0,0.3,0.2,0,0,0,0"/></S><D><DS X="947" Y="380"/></D><O><O X="31" Y="152" C="22" nosync="" P="0" type="tree"/><O X="212" Y="345" C="22" nosync="" P="0" type="tree"/><O X="259" Y="398" C="22" nosync="" P="0" type="tree"/><O X="1272" Y="702" C="22" nosync="" P="0" type="npc" name="nosferatu"/><O X="732" Y="392" C="22" nosync="" P="0" type="craft_table"/><O X="580" Y="776" C="22" nosync="" P="0" type="recipe" name="basic_shovel"/><O X="1458" Y="185" C="22" nosync="" P="0" type="rock"/><O X="1549" Y="181" C="22" nosync="" P="0" type="rock"/><O X="1259" Y="281" C="22" nosync="" P="0" type="rock"/><O X="1535" Y="799" C="11" nosync="" P="0" type="teleport" route="mine" id="1"/><O X="3598" Y="806" C="11" nosync="" P="0" type="teleport" route="mine" id="2"/><O X="1029" Y="375" C="22" nosync="" P="0" type="tree"/><O X="56" Y="805" C="22" nosync="" P="0" type="tree"/><O X="3670" Y="720" C="22" nosync="" P="0" type="rock"/><O X="3615" Y="552" C="22" nosync="" P="0" type="rock"/><O X="3727" Y="452" C="22" nosync="" P="0" type="copper_ore"/><O X="3873" Y="380" C="22" nosync="" P="0" type="gold_ore"/><O X="3988" Y="489" C="22" nosync="" P="0" type="copper_ore"/><O X="4120" Y="474" C="22" nosync="" P="0" type="iron_ore"/><O X="3950" Y="629" C="22" nosync="" P="0" type="rock"/><O X="4143" Y="792" C="22" nosync="" P="0" type="rock"/><O X="4101" Y="794" C="22" nosync="" P="0" type="rock"/><O X="4020" Y="703" C="22" nosync="" P="0" type="iron_ore"/></O><L/></Z></C>]],
	castle = [[<C><P L="16000" H="8000" MEDATA=";;;;-0;0:::1-"/><Z><S><S T="12" X="399" Y="386" L="797" H="26" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="0" Y="198" L="27" H="392" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="800" Y="193" L="34" H="405" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="397" Y="-1" L="834" H="31" P="0,0,0.3,0.2,0,0,100,0" o="324650"/><S T="8" X="399" Y="198" L="792" H="365" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="1"/><S T="8" X="1902" Y="1141" L="792" H="365" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="2" i="0,0,180937fe3b8.png"/><S T="12" X="1899" Y="952" L="826" H="13" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/><S T="12" X="1912" Y="1309" L="826" H="13" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/><S T="12" X="2302" Y="1137" L="20" H="451" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/><S T="12" X="1494" Y="1137" L="20" H="464" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/><S T="12" X="408" Y="729" L="704" H="18" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="1207" Y="-1" L="805" H="29" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="1607" Y="207" L="21" H="412" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="8" X="1204" Y="193" L="787" H="391" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="3"/><S T="8" X="417" Y="578" L="651" H="313" P="0,0,0.3,0.2,0,0,0,0" c="4" lua="5"/><S T="12" X="888" Y="331" L="158" H="112" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="1428" Y="330" L="339" H="129" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="1255" Y="136" L="58" H="273" P="0,0,0.3,0.2,0,0,0,0" o="324650" m=""/><S T="12" X="79" Y="685" L="43" H="348" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="401" Y="416" L="677" H="30" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="12" X="760" Y="594" L="46" H="393" P="0,0,0.3,0.2,0,0,0,0" o="324650"/><S T="1" X="417" Y="515" L="647" H="20" P="0,0,0,0.2,0,0,0,0"/><S T="0" X="180" Y="435" L="10" H="32" P="0,0,0.3,0.2,0,0,0,0"/></S><D><DS X="85" Y="355"/></D><O><O X="606" Y="341" C="22" nosync="" P="0" type="npc" name="edric"/><O X="1892" Y="1258" C="11" nosync="" P="0" type="teleport" route="arena" id="2"/><O X="300" Y="342" C="11" nosync="" P="0" type="teleport" route="arena" id="1"/><O X="693" Y="343" C="11" nosync="" P="0" type="teleport" route="bridge" id="1"/><O X="851" Y="256" C="11" nosync="" P="0" type="teleport" route="bridge" id="2"/><O X="1610" Y="1258" C="14" nosync="" P="0" type="monster_spawn"/><O X="550" Y="695" C="14" nosync="" P="0" type="final_boss"/><O X="2243" Y="1255" C="14" nosync="" P="0" type="monster_spawn"/><O X="1502" Y="242" C="14" nosync="" P="0" type="fiery_dragon"/><O X="172" Y="346" C="22" nosync="" P="0" type="recipe" name="bridge"/><O X="948" Y="260" C="22" nosync="" P="0" type="bridge"/></O><L/></Z></C>]]

}

local keys = {
	LEFT 	= 0,
	JUMP 	= 1,
	RIGHT 	= 2,
	DUCK 	= 3,
	SPACE 	= 32,
	KEY_0 	= 48,
	KEY_1	= 49,
	KEY_2	= 50,
	KEY_3	= 51,
	KEY_4	= 52,
	KEY_5	= 53,
	KEY_6	= 54,
	KEY_7	= 55,
	KEY_8	= 56,
	KEY_9	= 57,
	KEY_R 	= 82,
	KEY_X	= 88
}

local assets = {
	ui = {
		reply = "171d2f983ba.png",
		btnNext = "17eaa38a3f8.png",
		inventory = "17ff9b6b11f.png"
	},
	damageFg = "17f2a88995c.png",
	damageBg = "17f2a890350.png"
}

local dHandler = DataHandler.new("evt_nq", {
	recipes = {
		index = 1,
		type = "number",
		default = 0
	},
	questProgress = {
		index = 2,
		type = "string",
		default = ""
	},
	inventory = {
		index = 3,
		type = "string",
		default = ""
	}
})

local teleports = {
	mine = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.nosferatu
			return quest and (quest.completed or quest.stage >= 3)
		end,
		onEnter = function(player, terminalId)
			tfm.exec.setPlayerNightMode(terminalId == 2, player.name)
		end
	},
	arena = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.strength_test
			return quest and (quest.completed or quest.stage >= 2)
		end
	},
	bridge = {
		canEnter = function(player, terminalId)
			local quest = player.questProgress.strength_test
			return quest and quest.completed
		end
	}
}

local directionSequence = {}

local mineQuestCompletedPlayers, mineQuestIncompletedPlayers, totalPlayers, totalProcessedPlayers = 0, 0, 0, 0


